{% extends "base.html" %}

{% block title %}New Application - {{ get_text('dashboard_title') }}{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold mb-3">
            <i class="bi bi-plus-circle me-2"></i>
            {{ get_text('Create_New_Application') }}
        </h1>
        <p class="text-secondary">
             {{ get_text('Complete_this_form_to_create_a_new_credit_application_for_a_client') }}
        </p>
    </div>
</div>

<!-- Application Form -->
<form method="POST" action="{{ url_for('new_application') }}" id="newApplicationForm">
    <div class="row">
        <!-- Client Information -->
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card h-100">
                <h5 class="mb-4 pb-2 border-bottom border-primary border-opacity-25">
                    <i class="bi bi-person-badge me-2"></i>
                    {{ get_text('Client_Information') }}
                </h5>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">
                            {{ get_text('Client_Full_Name') }}<span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" name="client_name" 
                               value="{{ form_data.get('client_name', '') }}" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            DPI (CUI) <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" name="dpi" 
                               value="{{ form_data.get('dpi', '') }}" 
                               placeholder="1234567890123" required>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            {{ get_text('application_type') }}<span class="text-danger">*</span>
                        </label>
                        <select class="form-select" name="application_type" required>
                            <option value="">{{ get_text('Select_Type') }}</option>
                            <option value="New Mortgage" {% if form_data.get('application_type') == 'New Mortgage' %}selected{% endif %}>{{ get_text('New_Mortgage') }}</option>
                            <option value="Refinance" {% if form_data.get('application_type') == 'Refinance' %}selected{% endif %}>{{ get_text('Refinance') }}</option>
                            <option value="Home Equity" {% if form_data.get('application_type') == 'Home Equity' %}selected{% endif %}>{{ get_text('Home_Equity') }}</option>
                            <option value="Construction" {% if form_data.get('application_type') == 'Construction' %}selected{% endif %}>{{ get_text('Construction') }}</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ get_text('Email') }}</label>
                        <input type="email" class="form-control" name="email" 
                               value="{{ form_data.get('email', '') }}">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ get_text('Phone') }}</label>
                        <input type="tel" class="form-control" name="phone" 
                               value="{{ form_data.get('phone', '') }}">
                    </div>
                    
                    <div class="col-12 mb-3">
                        <label class="form-label">{{ get_text('Address') }}</label>
                        <textarea class="form-control" name="address" rows="2">{{ form_data.get('address', '') }}</textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Personal Information -->
        <div class="col-lg-6 mb-4">
            <div class="dashboard-card h-100">
                <h5 class="mb-4 pb-2 border-bottom border-success border-opacity-25">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    {{ get_text('Personal_Details') }}
                </h5>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label"> {{ get_text('Age') }}</label>
                        <input type="number" class="form-control" name="age" 
                               value="{{ form_data.get('age', 35) }}" min="18" max="100">
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label"> {{ get_text('Gender') }}</label>
                        <select class="form-select" name="gender">
                            <option value="Male" {% if form_data.get('gender') == 'Male' %}selected{% endif %}>{{ get_text('Male') }}</option>
                            <option value="Female" {% if form_data.get('gender') == 'Female' %}selected{% endif %}>{{ get_text('Female') }}</option>
                            <option value="Other" {% if form_data.get('gender') == 'Other' %}selected{% endif %}>{{ get_text('Other') }}</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label">{{ get_text('Marital_Status') }}</label>
                        <select class="form-select" name="marital_status">
                            <option value="Single" {% if form_data.get('marital_status') == 'Single' %}selected{% endif %}>{{ get_text('Single') }}</option>
                            <option value="Married" {% if form_data.get('marital_status') == 'Married' %}selected{% endif %}>{{ get_text('Married') }}</option>
                            <option value="Divorced" {% if form_data.get('marital_status') == 'Divorced' %}selected{% endif %}>{{ get_text('Divorced') }}</option>
                            <option value="Widowed" {% if form_data.get('marital_status') == 'Widowed' %}selected{% endif %}>{{ get_text('Widowed') }}</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ get_text('Employment_Status') }} </label>
                        <select class="form-select" name="employment_status">
                            <option value="Employed" {% if form_data.get('employment_status') == 'Employed' %}selected{% endif %}>{{ get_text('Employed') }} </option>
                            <option value="Self-Employed" {% if form_data.get('employment_status') == 'Self-Employed' %}selected{% endif %}> {{ get_text('Self-Employed') }}</option>
                            <option value="Unemployed" {% if form_data.get('employment_status') == 'Unemployed' %}selected{% endif %}>{{ get_text('Unemployed') }} </option>
                            <option value="Retired" {% if form_data.get('employment_status') == 'Retired' %}selected{% endif %}> {{ get_text('Retired') }} </option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ get_text('Employment_Duration_(Months)') }}</label>
                        <input type="number" class="form-control" name="employment_duration_months" 
                               value="{{ form_data.get('employment_duration_months', 24) }}" min="0">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ get_text('Monthly_Income_(Q)') }}</label>
                        <input type="number" class="form-control" name="monthly_income" id="monthlyIncome"
                               value="{{ form_data.get('monthly_income', 35000) }}" min="0">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ get_text('credit_score') }}</label>
                        <input type="number" class="form-control" name="credit_score" 
                               value="{{ form_data.get('credit_score', 650) }}" min="300" max="850">
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ get_text('dti_ratio') }}</label>
                        <input type="number" class="form-control" name="dti_ratio" id="dtiRatio"
                               value="{{ form_data.get('dti_ratio', 0.35) }}" min="0" max="1" step="0.01" readonly>
                        <div class="form-text">{{ get_text('Automatically_calculated_based_on_loan_parameters') }}</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{{ get_text('product_type') }}</label>
                        <select class="form-select" name="product_type">
                            <option value="Mortgage" {% if form_data.get('product_type') == 'Mortgage' %}selected{% endif %}>{{ get_text('Mortgage') }}</option>
                            <option value="Personal Loan" {% if form_data.get('product_type') == 'Personal Loan' %}selected{% endif %}>{{ get_text('Personal_Loan') }}</option>
                            <option value="Auto Loan" {% if form_data.get('product_type') == 'Auto Loan' %}selected{% endif %}>{{ get_text('Auto_Loan') }}</option>
                            <option value="Business Loan" {% if form_data.get('product_type') == 'Business Loan' %}selected{% endif %}>{{ get_text('Business_Loan') }}</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loan Information -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="dashboard-card">
                <h5 class="mb-4 pb-2 border-bottom border-warning border-opacity-25">
                    <i class="bi bi-bank me-2"></i>
                   {{ get_text('Loan_Information') }}

                </h5>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            <i class="bi bi-cash-stack me-1"></i>
                         {{ get_text('Loan_Amount_(Q)') }}
                        </label>
                        <!--<input type="number" class="form-control" name="loan_amount" id="loanAmount"
                               value="{{ form_data.get('loan_amount', 500000) }}" min="0" step=".01" >-->
                           <input type="number" value="0" class="form-control" name="loan_amount" id="loanAmount" value="{{ form_data.get('loan_amount', 0) }}" readonly>    
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            <i class="bi bi-house me-1"></i>
                           {{ get_text('Property_Price_(Q)') }}
                        </label>
                        <input type="number" class="form-control" name="property_price" id="propertyPrice"
                               value="{{ form_data.get('property_price', 0) }}" min="0" step=".01">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            <i class="bi bi-wallet2 me-1"></i>
                           {{ get_text('Down_Payment_(Q)') }}
                        </label>
                        <input type="number" class="form-control" name="down_payment" id="downPayment"
                               value="{{ form_data.get('down_payment', 0) }}" min="0" step=".01">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            <i class="bi bi-percent me-1"></i>
                            {{ get_text('Interest_Rate_(%)') }}
                        </label>
                        <input type="number" class="form-control" name="interest_rate" id="interestRate"
                               value="{{ form_data.get('interest_rate', 7.5) }}" min="0" max="30" step="0.01">
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label class="form-label">
                            <i class="bi bi-calendar3 me-1"></i>
                            {{ get_text('Loan_Duration_(Years)') }}
                        </label>
                        <input type="number" class="form-control" name="loan_duration" id="loanDuration"
                               value="{{ form_data.get('loan_duration', 20) }}" min="1" max="40">
                    </div>
                    
                    <!-- Calculated Metrics Display -->
                    <div class="col-md-9">
                        <div class="p-3 bg-primary bg-opacity-10 rounded">
                            <div class="row text-center">
                                <div class="col">
                                    <small class="text-secondary">{{ get_text('LTV_Ratio') }}</small>
                                    <div class="fw-bold text-primary" id="ltvRatio">66.7%</div>
                                </div>
                                <div class="col">
                                    <small class="text-secondary">{{ get_text('Down_Payment') }}</small>
                                    <div class="fw-bold text-success" id="downPaymentPercent">33.3%</div>
                                </div>
                                <div class="col">
                                    <small class="text-secondary">{{ get_text('Monthly_Payment') }}</small>
                                    <div class="fw-bold text-warning" id="monthlyPayment">Q4,247</div>
                                </div>
                                <div class="col">
                                    <small class="text-secondary">{{ get_text('Total_Interest') }}</small>
                                    <div class="fw-bold text-danger" id="totalInterest">Q519,280</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notes Section -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="dashboard-card">
                <h5 class="mb-3">
                    <i class="bi bi-chat-left-text me-2"></i>
                    Initial Notes
                </h5>
                <textarea class="form-control" name="notes" rows="3" 
                          placeholder="Add any initial notes about this application...">{{ form_data.get('notes', '') }}</textarea>
            </div>
        </div>
    </div>
    
    <!-- Submit Buttons -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('my_clients') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle me-2"></i>
                    Cancel
                </a>
                <div>
                    <button type="button" class="btn btn-outline-primary me-2" onclick="saveDraft()">
                        <i class="bi bi-save me-2"></i>
                        Save Draft
                    </button>
                    <button type="submit" class="btn btn-primary-gradient">
                        <i class="bi bi-check-circle me-2"></i>
                        Create Application
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_css %}
<style>
.form-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.form-label .text-danger {
    font-size: 0.9rem;
}

.border-primary {
    border-color: var(--primary-color) !important;
}

.border-success {
    border-color: var(--success-color) !important;
}

.border-warning {
    border-color: var(--warning-color) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Calculate loan metrics in real-time
function calculateMetrics() {
    const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
    const propertyPrice = parseFloat(document.getElementById('propertyPrice').value) || 1;
    const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
    const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    const loanDuration = parseFloat(document.getElementById('loanDuration').value) || 1;
    
    // Calculate LTV ratio
    const ltv = propertyPrice > 0 ? (loanAmount / propertyPrice * 100).toFixed(2) : 0;
    document.getElementById('ltvRatio').textContent = ltv + '%';
    
    // Calculate down payment percentage
    const downPaymentPercent = propertyPrice > 0 ? (downPayment / propertyPrice * 100).toFixed(2) : 0;
    document.getElementById('downPaymentPercent').textContent = downPaymentPercent + '%';
    
    // Calculate monthly payment
    const monthlyRate = interestRate / 100 / 12;
    const numberOfPayments = loanDuration * 12;
    let monthlyPayment = 0;
    
    if (monthlyRate > 0) {
        monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / 
                        (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
    } else {
        monthlyPayment = loanAmount / numberOfPayments;
    }
    
    document.getElementById('monthlyPayment').textContent = 'Q' + monthlyPayment.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    
    // Calculate total interest
    const totalPayment = monthlyPayment * numberOfPayments;
    const totalInterest = totalPayment - loanAmount;
    document.getElementById('totalInterest').textContent = 'Q' + totalInterest.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    
    // Update down payment when property price or loan amount changes
    /*if (propertyPrice > 0 && loanAmount > 0 && downPayment === 0) {
        const calculatedDownPayment = propertyPrice - loanAmount;
        console.log(calculatedDownPayment);
        if (calculatedDownPayment > 0) {
            document.getElementById('downPayment').value = calculatedDownPayment;
            console.log('this line 355')
        }
    }*/
}

// Add event listeners
document.addEventListener('DOMContentLoaded', function() {
    const inputs = ['loanAmount', 'propertyPrice', 'downPayment', 'interestRate', 'loanDuration'];
    inputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', calculateMetrics);
        }
    });
    
    // Calculate initial values
    calculateMetrics();
});

// DTI Calculation functionality
function calculateDTI() {
    const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 0;
    const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    const loanDuration = parseFloat(document.getElementById('loanDuration').value) || 0;
    const monthlyIncome = parseFloat(document.getElementById('monthlyIncome').value) || 1;
    
    if (loanAmount > 0 && interestRate > 0 && loanDuration > 0 && monthlyIncome > 0) {
        // Calculate monthly payment using mortgage formula
        const monthlyRate = interestRate / 100 / 12;
        const numPayments = loanDuration * 12;
        
        let monthlyPayment;
        if (monthlyRate > 0) {
            // Standard mortgage payment formula
            monthlyPayment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / 
                           (Math.pow(1 + monthlyRate, numPayments) - 1);
        } else {
            // Zero interest case
            monthlyPayment = loanAmount / numPayments;
        }
        
        // Calculate DTI ratio
        const dtiRatio = monthlyPayment / monthlyIncome;
        
        // Update DTI field
        document.getElementById('dtiRatio').value = dtiRatio.toFixed(3);
        
        // Update visual indicator
        const dtiField = document.getElementById('dtiRatio');
        dtiField.classList.remove('border-success', 'border-warning', 'border-danger');
        
        if (dtiRatio <= 0.28) {
            dtiField.classList.add('border-success');
        } else if (dtiRatio <= 0.36) {
            dtiField.classList.add('border-warning');
        } else {
            dtiField.classList.add('border-danger');
        }
    }
}

// Add event listeners for DTI calculation
document.addEventListener('DOMContentLoaded', function() {
    const loanFields = ['loanAmount', 'interestRate', 'loanDuration', 'monthlyIncome'];
    
    loanFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', calculateDTI);
            field.addEventListener('change', calculateDTI);
        }
    });
    
    // Calculate DTI on page load
    calculateDTI();
});

// Save draft functionality
function saveDraft() {
    const formData = new FormData(document.getElementById('newApplicationForm'));
    // Store in localStorage
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    localStorage.setItem('applicationDraft', JSON.stringify(data));
    
    // Show notification
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        <i class="bi bi-check-circle me-2"></i>
        Draft saved successfully!
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

// Load draft if exists
document.addEventListener('DOMContentLoaded', function() {
    const draft = localStorage.getItem('applicationDraft');
    if (draft) {
        const data = JSON.parse(draft);
        // You can add a prompt here to ask if user wants to load the draft
        console.log('Draft found in localStorage');
    }
});

// Form validation
document.getElementById('newApplicationForm').addEventListener('submit', function(e) {
    const requiredFields = this.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Please fill in all required fields');
    }
});




 function updateLoanAmount() {
    const ppEl = document.getElementById('propertyPrice');
    const dpEl = document.getElementById('downPayment');
    const laEl = document.getElementById('loanAmount');

    const propertyPrice = parseFloat(ppEl.value) || 0;
    const downPayment   = parseFloat(dpEl.value) || 0;

    // Resultado sin negativos
    const raw = propertyPrice - downPayment;
    const loanAmount = Math.max(raw, 0); // <- nunca < 0

    laEl.value = loanAmount.toFixed(2);

    // (Opcional) Validación: enganche no mayor al precio
    dpEl.max = propertyPrice; // activa validación nativa HTML
    if (downPayment > propertyPrice) {
      dpEl.setCustomValidity('El enganche no puede ser mayor al precio de la propiedad.');
    } else {
      dpEl.setCustomValidity('');
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('propertyPrice').addEventListener('input', updateLoanAmount);
    document.getElementById('downPayment').addEventListener('input', updateLoanAmount);
    document.getElementById('downPayment').addEventListener('change', updateLoanAmount);
    updateLoanAmount();
  });
</script>
{% endblock %}