{% extends "base.html" %}

{% block title %}{{ get_text('data_input_title') if get_text('data_input_title') != 'data_input_title' else 'Data Input' }} - {{ get_text('dashboard_title') }}{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <h1 class="display-6 fw-bold mb-3">
            <i class="bi bi-plus-circle me-2"></i>
            Save New Application Record
        </h1>
        <p class="text-secondary">
            Complete this form to save a finalized application record to the system.
        </p>
    </div>
</div>

<!-- Flash Messages are handled in base.html -->

<!-- Main Form -->
<div class="row">
    <div class="col-12">
        <div class="dashboard-card">
            <form method="POST" action="{{ url_for('data_input') }}">
                
                <!-- Client & Application Info Section -->
                <div class="mb-5">
                    <h5 class="mb-4 pb-2 border-bottom border-primary border-opacity-25">
                        <i class="bi bi-person-badge me-2"></i>
                        Client & Application Info
                    </h5>
                    <div class="row">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-person me-1"></i>
                                Client Full Name *
                            </label>
                            <input type="text" name="client_name" class="form-control" 
                                   value="{{ form_data.get('client_name', '') }}" required>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-card-text me-1"></i>
                                DPI (CUI) *
                            </label>
                            <input type="text" name="dpi" class="form-control" 
                                   value="{{ form_data.get('dpi', '') }}" 
                                   placeholder="e.g., 1234567890123" required>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-file-earmark me-1"></i>
                                Application Type *
                            </label>
                            <input type="text" name="application_type" class="form-control" 
                                   value="{{ form_data.get('application_type', '') }}"
                                   placeholder="e.g., New Mortgage, Refinance" required>
                        </div>
                    </div>
                </div>

                <!-- Profile & Income Section -->
                <div class="mb-5">
                    <h5 class="mb-4 pb-2 border-bottom border-success border-opacity-25">
                        <i class="bi bi-person-lines-fill me-2"></i>
                        Profile & Income Information
                    </h5>
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-calendar3 me-1"></i>
                                Age
                            </label>
                            <input type="number" name="age" class="form-control" 
                                   value="{{ form_data.get('age', '') }}"
                                   min="18" max="100" placeholder="e.g., 35">
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-gender-ambiguous me-1"></i>
                                Gender
                            </label>
                            <select name="gender" class="form-select">
                                <option value="Male" {% if form_data.get('gender') == 'Male' %}selected{% endif %}>Male</option>
                                <option value="Female" {% if form_data.get('gender') == 'Female' %}selected{% endif %}>Female</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-heart me-1"></i>
                                Marital Status
                            </label>
                            <select name="marital_status" class="form-select">
                                <option value="Single" {% if form_data.get('marital_status') == 'Single' %}selected{% endif %}>Single</option>
                                <option value="Married" {% if form_data.get('marital_status') == 'Married' %}selected{% endif %}>Married</option>
                                <option value="Divorced" {% if form_data.get('marital_status') == 'Divorced' %}selected{% endif %}>Divorced</option>
                                <option value="Widowed" {% if form_data.get('marital_status') == 'Widowed' %}selected{% endif %}>Widowed</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-currency-dollar me-1"></i>
                                Monthly Income (GTQ)
                            </label>
                            <input type="number" step="0.01" name="monthly_income" class="form-control" 
                                   value="{{ form_data.get('monthly_income', '') }}"
                                   min="0" placeholder="e.g., 25000.00">
                            <div class="form-text">Guatemalan Quetzales</div>
                        </div>
                    </div>
                </div>

                <!-- Loan Details & Status Section -->
                <div class="mb-5">
                    <h5 class="mb-4 pb-2 border-bottom border-warning border-opacity-25">
                        <i class="bi bi-bank me-2"></i>
                        Loan Details & Final Status
                    </h5>
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-graph-up me-1"></i>
                                Credit Score
                            </label>
                            <input type="number" name="credit_score" class="form-control" 
                                   value="{{ form_data.get('credit_score', '') }}"
                                   min="300" max="850" placeholder="e.g., 650">
                            <div class="form-text">Range: 300-850</div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-tag me-1"></i>
                                Product Type
                            </label>
                            <input type="text" name="product_type" class="form-control" 
                                   value="{{ form_data.get('product_type', '') }}"
                                   placeholder="e.g., Refinance, Purchase">
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-clipboard-check me-1"></i>
                                Final Loan Status
                            </label>
                            <select name="loan_status" class="form-select">
                                <option value="In-Process" {% if form_data.get('loan_status') == 'In-Process' %}selected{% endif %}>In-Process</option>
                                <option value="Completed" {% if form_data.get('loan_status') == 'Completed' %}selected{% endif %}>Completed</option>
                                <option value="Withdrawn" {% if form_data.get('loan_status') == 'Withdrawn' %}selected{% endif %}>Withdrawn</option>
                                <option value="Cancelled" {% if form_data.get('loan_status') == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <label class="form-label">
                                <i class="bi bi-check-circle me-1"></i>
                                Final Loan Decision
                            </label>
                            <select name="loan_decision" class="form-select">
                                <option value="">N/A</option>
                                <option value="Approved" {% if form_data.get('loan_decision') == 'Approved' %}selected{% endif %}>Approved</option>
                                <option value="Declined" {% if form_data.get('loan_decision') == 'Declined' %}selected{% endif %}>Declined</option>
                                <option value="Conditional" {% if form_data.get('loan_decision') == 'Conditional' %}selected{% endif %}>Conditional Approval</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary-gradient btn-lg">
                        <i class="bi bi-save me-2"></i>
                        ðŸ’¾ Save Application Record
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Info Cards -->
<div class="row mt-4">
    <div class="col-md-4 mb-3">
        <div class="dashboard-card bg-success bg-opacity-10">
            <div class="text-center">
                <i class="bi bi-shield-check" style="font-size: 2.5rem; color: #10B981; margin-bottom: 1rem;"></i>
                <h6 class="text-success">Secure Data Storage</h6>
                <p class="text-secondary small mb-0">
                    All application data is securely stored and automatically backed up.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="dashboard-card bg-primary bg-opacity-10">
            <div class="text-center">
                <i class="bi bi-cpu" style="font-size: 2.5rem; color: #4F46E5; margin-bottom: 1rem;"></i>
                <h6 class="text-primary">AI Model Integration</h6>
                <p class="text-secondary small mb-0">
                    New applications automatically update the ML models for better predictions.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="dashboard-card bg-warning bg-opacity-10">
            <div class="text-center">
                <i class="bi bi-graph-up-arrow" style="font-size: 2.5rem; color: #F59E0B; margin-bottom: 1rem;"></i>
                <h6 class="text-warning">Real-time Analytics</h6>
                <p class="text-secondary small mb-0">
                    Application data is immediately available in dashboards and reports.
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Recent Applications (if any exist) -->
<div class="row mt-4">
    <div class="col-12">
        <div class="dashboard-card">
            <h5 class="mb-4">
                <i class="bi bi-clock-history me-2"></i>
                Recently Added Applications
            </h5>
            <div id="recentApplications">
                <div class="text-center text-secondary py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mt-2">No recent applications to display</p>
                    <p class="small">New applications will appear here after being saved</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.form-label {
    font-weight: 600;
    color: var(--text-primary);
}

.form-label i {
    color: var(--primary-color);
    opacity: 0.7;
}

.border-primary {
    border-color: var(--primary-color) !important;
}

.border-success {
    border-color: var(--success-color) !important;
}

.border-warning {
    border-color: var(--warning-color) !important;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.btn-primary-gradient:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
}

/* Form validation styles */
.form-control:invalid {
    border-color: var(--danger-color);
}

.form-control:valid {
    border-color: var(--success-color);
}

/* Responsive improvements */
@media (max-width: 768px) {
    .col-lg-3,
    .col-lg-4 {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const form = document.querySelector('form');
    const requiredFields = form.querySelectorAll('input[required]');
    
    // Add real-time validation
    requiredFields.forEach(field => {
        field.addEventListener('blur', function() {
            if (this.value.trim() === '') {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    });
    
    // Form submission with loading state
    form.addEventListener('submit', function(e) {
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="bi bi-hourglass-spin me-2"></i>Saving...';
        submitBtn.disabled = true;
        
        // Re-enable after 3 seconds (in case of error)
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 3000);
    });
    
    // Auto-format DPI input
    const dpiInput = document.querySelector('input[name="dpi"]');
    if (dpiInput) {
        dpiInput.addEventListener('input', function() {
            // Remove non-numeric characters
            this.value = this.value.replace(/\D/g, '');
            // Limit to 13 digits (Guatemala DPI format)
            if (this.value.length > 13) {
                this.value = this.value.slice(0, 13);
            }
        });
    }
    
    // Auto-format credit score
    const creditScoreInput = document.querySelector('input[name="credit_score"]');
    if (creditScoreInput) {
        creditScoreInput.addEventListener('input', function() {
            if (this.value > 850) this.value = 850;
            if (this.value < 300 && this.value !== '') this.value = 300;
        });
    }
    
    // Format monetary input
    const incomeInput = document.querySelector('input[name="monthly_income"]');
    if (incomeInput) {
        incomeInput.addEventListener('blur', function() {
            if (this.value) {
                const value = parseFloat(this.value);
                this.value = value.toFixed(2);
            }
        });
    }
});
</script>
{% endblock %}